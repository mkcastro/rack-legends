name: Lighthouse CI

on:
  deployment_status:

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    # Only run on successful production deployments from main branch
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment_status.environment == 'Production' &&
      github.ref == 'refs/heads/main'
    steps:
      - name: Debug deployment info
        run: |
          echo "Deployment URL: ${{ github.event.deployment_status.target_url }}"
          echo "Environment: ${{ github.event.deployment_status.environment }}"
          echo "Ref: ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if production deployment
        id: check_production
        run: |
          if [[ "${{ github.event.deployment_status.environment }}" == "Production" ]]; then
            echo "is_production=true" >> $GITHUB_OUTPUT
            # Use deployment URL from GitHub event
            echo "production_url=${{ github.event.deployment_status.target_url }}" >> $GITHUB_OUTPUT
            echo "âœ… This is a production deployment"
            echo "Deployment URL: ${{ github.event.deployment_status.target_url }}"
          else
            echo "is_production=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Skipping: This is a preview deployment"
          fi

      - name: Wait for deployment
        if: steps.check_production.outputs.is_production == 'true'
        run: sleep 5

      - name: Run Lighthouse CI
        id: lighthouse_ci
        if: steps.check_production.outputs.is_production == 'true'
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ steps.check_production.outputs.production_url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
        continue-on-error: true

      - name: Check if Lighthouse ran successfully
        id: check_lighthouse
        if: steps.check_production.outputs.is_production == 'true'
        run: |
          if [ -d ".lighthouseci" ] && [ "$(ls -A .lighthouseci/*.json 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Format Lighthouse Results
        id: format_lighthouse_score
        if: steps.check_production.outputs.is_production == 'true' && steps.check_lighthouse.outputs.success == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find Lighthouse report files
            const lighthouseDir = '.lighthouseci';

            if (!fs.existsSync(lighthouseDir)) {
              core.setFailed('Lighthouse directory not found');
              return;
            }

            const files = fs.readdirSync(lighthouseDir);
            const reportFiles = files.filter(f => f.startsWith('lhr-') && f.endsWith('.json'));

            if (reportFiles.length === 0) {
              core.setFailed('No Lighthouse reports found');
              return;
            }

            const reportPath = path.join(lighthouseDir, reportFiles[0]);
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const categories = report.categories;

            const scores = {
              performance: Math.round(categories.performance.score * 100),
              accessibility: Math.round(categories.accessibility.score * 100),
              'best-practices': Math.round(categories['best-practices'].score * 100),
              seo: Math.round(categories.seo.score * 100)
            };

            const emoji = (score) => {
              if (score >= 90) return 'ðŸŸ¢';
              if (score >= 50) return 'ðŸŸ ';
              return 'ðŸ”´';
            };

            core.summary
              .addHeading('âš¡ Lighthouse Report')
              .addTable([
                [{data: 'Category', header: true}, {data: 'Score', header: true}],
                [`${emoji(scores.performance)} Performance`, `${scores.performance}`],
                [`${emoji(scores.accessibility)} Accessibility`, `${scores.accessibility}`],
                [`${emoji(scores['best-practices'])} Best Practices`, `${scores['best-practices']}`],
                [`${emoji(scores.seo)} SEO`, `${scores.seo}`]
              ])
              .write();

            core.info(`Performance: ${scores.performance}`);
            core.info(`Accessibility: ${scores.accessibility}`);
            core.info(`Best Practices: ${scores['best-practices']}`);
            core.info(`SEO: ${scores.seo}`);

      - name: Post Results Summary
        if: steps.check_production.outputs.is_production == 'true' && steps.check_lighthouse.outputs.success == 'true'
        run: |
          echo "## âš¡ Lighthouse Audit Completed"
          echo "Production deployment has been audited for performance."
          echo "View detailed results in the artifacts above."
